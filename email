
  environment {
    GIT_BRANCH   = "${BRANCH_NAME}"
    MOTIO_SERVER = "https://cgrptmcip01.cloud.cammis.ca.gov"
  }

  parameters {
    choice(name: 'SOURCE_ENV', choices: ['Cognos-DEV/TEST', 'Cognos-SIT', 'Cognos-UAT'], description: 'Select the Cognos source environment.')
    choice(name: 'TARGET_ENV', choices: ['Cognos-SIT', 'Cognos-UAT', 'Cognos-PRD'], description: 'Select the target Cognos environment.')
    string(name: 'PROJECT_NAME', defaultValue: '', description: 'MotioCI project name (manual entry if not auto-listed).')
    string(name: 'OBJECT_PATH', defaultValue: '', description: 'Cognos path to promote (leave empty to deploy whole project).')
    booleanParam(name: 'AUTO_LABEL', defaultValue: true, description: 'Create Pre/Post deployment labels automatically.')
    string(name: 'ROLLBACK_LABEL', defaultValue: '', description: 'Optional: enter label to redeploy.')
  }

  options {
    disableConcurrentBuilds()
    timestamps()
  }

  stages {

    /* -----------------------------------------------------------------------
       1. INITIALIZE
    ----------------------------------------------------------------------- */
    stage('Initialize') {
      steps {
        script {
          echo """
          ================================================
          MotioCI â†’ Cognos Deployment Pipeline Initialized
          ================================================
          Source:   ${params.SOURCE_ENV}
          Target:   ${params.TARGET_ENV}
          Project:  ${params.PROJECT_NAME ?: '(not set)'}
          Path:     ${params.OBJECT_PATH ?: '(full project)'}
          Rollback: ${params.ROLLBACK_LABEL ?: 'N/A'}
          ================================================
          """
        }
      }
    }

    /* -----------------------------------------------------------------------
       2. MOTIOCI LOGIN
    ----------------------------------------------------------------------- */
    stage('MotioCI Login') {
      steps {
        withCredentials([file(credentialsId: 'cognos-credentials', variable: 'CREDENTIALS_FILE')]) {
          container('python') {
            sh '''
              set -euo pipefail
              cd MotioCI/api/CLI

              echo "ðŸ”§ Installing MotioCI CLI dependencies..."
              python3 -m pip install --user -r requirements.txt

              echo "ðŸ” Logging in to MotioCI..."
              python3 ci-cli.py --server="$MOTIO_SERVER" \
                login --credentialsFile "$CREDENTIALS_FILE" > login.out 2>&1 || true

              awk 'match($0,/(Auth[[:space:]]*[Tt]oken|x-auth_token|xauthtoken)[[:space:]]*[:=][[:space:]]*([A-Za-z0-9._-]+)/,m){print m[2]}' login.out | tail -n1 > ../token.txt || true
              TOKEN=$(cat ../token.txt 2>/dev/null || true)

              if [ -z "$TOKEN" ] || [ "${#TOKEN}" -lt 10 ]; then
                echo "âŒ ERROR: Failed to capture MotioCI token!"
                cat login.out
                exit 1
              fi

              echo "âœ… Login successful. Token length: ${#TOKEN}"
            '''

            // === Dynamic discovery: projects and folders ===
            script {
              echo "ðŸ” Fetching available MotioCI projects for ${params.SOURCE_ENV}..."

              sh '''
                set -e
                cd MotioCI/api/CLI
                python3 ci-cli.py --server="$MOTIO_SERVER" project ls \
                  --xauthtoken "$(cat ../token.txt)" \
                  --instanceName "${SOURCE_ENV}" > ../projects.json

                grep -o "'name': '[^']*'" ../projects.json | cut -d"'" -f4 | sort | uniq > ../projects.txt
              '''

              def projects = readFile('MotioCI/projects.txt').split('\n').findAll { it?.trim() }
              echo "âœ… Found ${projects.size()} projects."

              // Dynamically update PROJECT_NAME choices for next run
              def job = Jenkins.instance.getItemByFullName(env.JOB_NAME)
              def prop = job.getProperty(ParametersDefinitionProperty)
              def newParams = [
                new ChoiceParameterDefinition('PROJECT_NAME', projects as String[], 'Select MotioCI Project')
              ]
              prop.parameterDefinitions.removeAll { it.name == 'PROJECT_NAME' }
              prop.parameterDefinitions.addAll(newParams)
              job.save()
              echo "PROJECT_NAME dropdown updated for next build."

              // Optional: also fetch folders for current project
              if (params.PROJECT_NAME?.trim()) {
                echo "Fetching folders for project ${params.PROJECT_NAME}..."
                sh '''
                  cd MotioCI/api/CLI
                  python3 ci-cli.py --server="$MOTIO_SERVER" versionedItems ls \
                    --xauthtoken "$(cat ../token.txt)" \
                    --instanceName "${SOURCE_ENV}" \
                    --projectName "${PROJECT_NAME}" --currentOnly True > ../folders.json
                  grep "prettyPath" ../folders.json | cut -d"'" -f4 | sort | uniq > ../folders.txt
                '''
                def folders = readFile('MotioCI/folders.txt').split('\n').findAll { it?.trim() }
                echo "Found ${folders.size()} folder paths."
                prop.parameterDefinitions.removeAll { it.name == 'OBJECT_PATH' }
                prop.parameterDefinitions.add(new ChoiceParameterDefinition('OBJECT_PATH', folders as String[], 'Select folder or report path'))
                job.save()
                echo "OBJECT_PATH dropdown updated for next build."
              } else {
                echo "Skipping folder discovery (no project selected yet)."
              }
            }
          }
        }
      }
    }
