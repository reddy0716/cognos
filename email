import groovy.json.JsonSlurper

// ===== CONFIGURATION =====
def MOTIO_SERVER = "https://cgrptmcip01.cloud.cammis.ca.gov"
def SOURCE_ENV   = SOURCE_ENV ?: "Cognos-DEV/TEST"
def WORKSPACE    = "/var/lib/jenkins/combined-devops-cognos-deployments/MotioCI/api/CLI"
def PYTHON       = "python3"
def CRED_ID      = "cognos-credentials"
// ==========================

def results = []
def TOKEN = ""

// --- Step 1Ô∏è‚É£ Get Jenkins Credential Object ---
try {
    results << "üîç Step1: Searching Jenkins credentials for ID: ${CRED_ID}"
    def j = Jenkins.getInstance()
    def credsList = j.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0]
    def allCreds = credsList.getStore().getCredentials(com.cloudbees.plugins.credentials.domains.Domain.global())
    def cred = allCreds.find { it.id == CRED_ID }

    if (!cred) {
        results << "‚ùå Step1: Credential '${CRED_ID}' not found in Jenkins!"
        return results
    }

    results << "‚úÖ Step1: Credential found (${cred.id})"

    // --- Step 2Ô∏è‚É£ Write Temp Credential File ---
    def tmpCredFile = File.createTempFile("motio-cred-", ".json")
    tmpCredFile.deleteOnExit()
    tmpCredFile.bytes = cred.getContent()
    results << "‚úÖ Step2: Temporary credentials.json created at: ${tmpCredFile.absolutePath}"

    // --- Step 3Ô∏è‚É£ Verify CLI Path ---
    def cliFile = new File("${WORKSPACE}/ci-cli.py")
    if (!cliFile.exists()) {
        results << "‚ùå Step3: CLI file not found at ${cliFile.absolutePath}"
        tmpCredFile.delete()
        return results
    }
    results << "‚úÖ Step3: CLI located successfully at ${cliFile.absolutePath}"

    // --- Step 4Ô∏è‚É£ Login to MotioCI ---
    results << "üîç Step4: Running login command..."
    def loginCmd = [
        "bash", "-c",
        """
        cd ${WORKSPACE} &&
        ${PYTHON} ci-cli.py --server=${MOTIO_SERVER} \
          login --credentialsFile ${tmpCredFile.absolutePath}
        """
    ]
    results << "üß† Executing command: ${loginCmd.join(' ')}"

    def loginProc = loginCmd.execute()
    def loginOut = new StringBuffer()
    def loginErr = new StringBuffer()
    loginProc.consumeProcessOutput(loginOut, loginErr)
    loginProc.waitFor()

    results << "üîπ Login STDOUT:\n${loginOut.toString()}"
    results << "üîπ Login STDERR:\n${loginErr.toString()}"

    // --- Step 5Ô∏è‚É£ Extract token from output ---
    TOKEN = loginOut.toString().find(/[A-Za-z0-9._-]{20,}/)
    if (!TOKEN || TOKEN.length() < 10) {
        results << "‚ùå Step5: Login did not return a valid token!"
        results << "‚ö†Ô∏è Check credentials.json or MotioCI server URL."
        tmpCredFile.delete()
        return results
    }

    results << "‚úÖ Step5: Token retrieved successfully (${TOKEN.take(10)}...)"

    // --- Step 6Ô∏è‚É£ List Projects ---
    results << "üîç Step6: Running project listing..."
    def listCmd = [
        "bash", "-c",
        """
        cd ${WORKSPACE} &&
        ${PYTHON} ci-cli.py --server=${MOTIO_SERVER} \
          project ls --xauthtoken ${TOKEN} \
          --instanceName ${SOURCE_ENV}
        """
    ]
    results << "üß† Executing command: ${listCmd.join(' ')}"

    def listProc = listCmd.execute()
    def listOut = new StringBuffer()
    def listErr = new StringBuffer()
    listProc.consumeProcessOutput(listOut, listErr)
    listProc.waitFor()

    def raw = listOut.toString().trim()
    results << "üîπ CLI STDOUT (first 400 chars):\n${raw.take(400)}"
    results << "üîπ CLI STDERR:\n${listErr.toString()}"

    if (!raw) {
        results << "‚ö†Ô∏è Step6: Empty response from CLI ‚Äî token or env might be invalid."
        tmpCredFile.delete()
        return results
    }

    // --- Step 7Ô∏è‚É£ Parse JSON Output ---
    try {
        results << "üîç Step7: Parsing JSON..."
        def json = new JsonSlurper().parseText(raw)
        def edges = json?.data?.instances?.edges ?: []
        def projects = []
        edges.each { e ->
            e?.node?.projects?.edges?.each { p ->
                def name = p?.node?.name
                if (name) projects << name
            }
        }

        if (projects.isEmpty()) {
            results << "‚ö†Ô∏è Step7: JSON parsed successfully, but no projects found."
        } else {
            results << "‚úÖ Step7: Found ${projects.size()} projects."
            results.addAll(projects.unique().sort())
        }
    } catch (Exception pe) {
        results << "‚ùå Step7: JSON parsing failed ‚Äî ${pe.message}"
        results << "‚ö†Ô∏è Raw JSON snippet:\n${raw.take(500)}"
    }

    tmpCredFile.delete()
    results << "‚úÖ Cleanup: Temporary credential file deleted."

    return results

} catch (Exception e) {
    return ["‚ùå Unexpected error: ${e.message}", e.toString()]
}
