stage('Validate Source Content') {
  steps {
    container('python') {
      script {
        if (params.OBJECT_PATH?.trim()) {
          sh '''
            set -e
            cd MotioCI/api/CLI
            TOKEN=$(cat ../../token.txt)
            echo "Validating object path in source project..."
            echo "Using searchPath=/content${OBJECT_PATH}"

            python3 ci-cli.py versionedItems ls \
              --server="$MOTIO_SERVER" \
              --instanceName "$SOURCE_INSTANCE" \
              --projectName "$PROJECT_NAME" \
              --xauthtoken "$TOKEN" \
              --searchPath="starts:/content/" \
              --currentOnly=True | grep -F "${OBJECT_PATH}" || {
                echo "Object ${OBJECT_PATH} not found in source project.";
                echo "Tip: Try checking the exact path in MotioCI UI (right-click → Properties).";
                exit 1; }

            echo "Object ${OBJECT_PATH} exists in source project; proceeding with label creation."
          '''
        } else {
          echo "No OBJECT_PATH provided — deploying entire project (skipping object validation)."
        }
      }
    }
  }
}
