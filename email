import groovy.json.JsonSlurper

// Jenkins credential lookup via built-in classes
def j = Jenkins.getInstance()
def credsList = j.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0]
def allCreds = credsList.getStore().getCredentials(com.cloudbees.plugins.credentials.domains.Domain.global())
def cred = allCreds.find { it.id == "cognos-credentials" }

if (cred == null) {
    return ["Credential 'cognos-credentials' not found in Jenkins"]
}

// ===== CONFIGURATION =====
def MOTIO_SERVER = "https://cgrptmcip01.cloud.cammis.ca.gov"
def SOURCE_ENV   = SOURCE_ENV ?: "Cognos-DEV/TEST"
def WORKSPACE    = "/var/lib/jenkins/combined-devops-cognos-deployments/MotioCI/api/CLI"
def PYTHON       = "python3"
// ==========================

def results = []
def TOKEN = ""


def tmpCredFile = File.createTempFile("motio-cred-", ".json")
tmpCredFile.deleteOnExit()
tmpCredFile.bytes = cred.getContent()
results << "Step1: Credential file created at ${tmpCredFile.absolutePath}"


try {
    def loginCmd = [
        "bash", "-c",
        """
        cd ${WORKSPACE} &&
        ${PYTHON} ci-cli.py --server=${MOTIO_SERVER} \
          login --credentialsFile ${tmpCredFile.absolutePath} > login.out 2>&1 &&
        awk 'match(\$0,/(xauthtoken|Auth[[:space:]]*Token)[[:space:]]*[:=][[:space:]]*([A-Za-z0-9._-]+)/,m){print m[2]}' login.out | tail -n1
        """
    ]
    def loginProc = loginCmd.execute()
    def loginOut = new StringBuffer()
    def loginErr = new StringBuffer()
    loginProc.consumeProcessOutput(loginOut, loginErr)
    loginProc.waitFor()

    TOKEN = loginOut.toString().trim()
    results << "Login STDOUT: ${loginOut.toString()}"
    results << "Login STDERR: ${loginErr.toString()}"

    if (!TOKEN || TOKEN.length() < 10) {
        results << "Step2: Login failed — no valid token retrieved!"
        tmpCredFile.delete()
        return results
    }

    results << "Step2: Token captured (${TOKEN.take(10)}...)"

    def listCmd = [
        "bash", "-c",
        """
        cd ${WORKSPACE} &&
        ${PYTHON} ci-cli.py --server=${MOTIO_SERVER} \
          project ls --xauthtoken ${TOKEN} \
          --instanceName ${SOURCE_ENV}
        """
    ]
    def listProc = listCmd.execute()
    def listOut = new StringBuffer()
    def listErr = new StringBuffer()
    listProc.consumeProcessOutput(listOut, listErr)
    listProc.waitFor()

    def raw = listOut.toString().trim()
    results << "CLI STDOUT: ${raw.take(400)}"
    results << "CLI STDERR: ${listErr.toString()}"

    if (!raw) {
        results << "No projects returned — check env ${SOURCE_ENV}"
        tmpCredFile.delete()
        return results
    }

    try {
        def json = new JsonSlurper().parseText(raw)
        def edges = json?.data?.instances?.edges ?: []
        def projects = []
        edges.each { e ->
            e?.node?.projects?.edges?.each { p ->
                def name = p?.node?.name
                if (name) projects << name
            }
        }
        if (projects.isEmpty()) {
            results << "JSON parsed but no projects found"
        } else {
            results << "Found ${projects.size()} projects"
            results.addAll(projects.unique().sort())
        }
    } catch (pe) {
        results << "JSON parsing error: ${pe.message}"
    }

    tmpCredFile.delete()
    return results

} catch (Exception e) {
    tmpCredFile.delete()
    return ["Unexpected error: ${e.message}"]
}
