import groovy.json.JsonSlurper
import com.cloudbees.plugins.credentials.CredentialsProvider
import com.cloudbees.plugins.credentials.common.StandardFileCredentials

// ===== CONFIGURATION =====
def MOTIO_SERVER = "https://cgrptmcip01.cloud.cammis.ca.gov"
def SOURCE_ENV   = SOURCE_ENV ?: "Cognos-DEV/TEST"  // Parameter from dropdown
def WORKSPACE    = "/var/lib/jenkins/MotioCI/CLI/combined-devops-cognos-deployments/MotioCI/api/CLI"
def PYTHON       = "python3"
def CRED_ID      = "cognos-credentials"  // Jenkins File credential containing credentials.json
// ==========================

def projects = []
def TOKEN = ""

// --- Retrieve Jenkins File Credential (credentials.json) ---
def cred = CredentialsProvider.lookupCredentials(
    StandardFileCredentials.class,
    Jenkins.instance,
    null,
    null
).find { it.id == CRED_ID }

if (!cred) {
    return ["Jenkins credential '${CRED_ID}' not found"]
}

// Write temporary credentials file
def tmpCredFile = File.createTempFile("motio-cred-", ".json")
tmpCredFile.deleteOnExit()
tmpCredFile.bytes = cred.content

try {
    // --- Login to MotioCI ---
    def loginCmd = [
        "bash", "-c",
        """
        cd ${WORKSPACE} &&
        ${PYTHON} ci-cli.py --server=${MOTIO_SERVER} \
          login --credentialsFile ${tmpCredFile.absolutePath} > login.out 2>&1 &&
        awk 'match(\$0,/(xauthtoken|Auth[[:space:]]*Token)[[:space:]]*[:=][[:space:]]*([A-Za-z0-9._-]+)/,m){print m[2]}' login.out | tail -n1
        """
    ]
    def loginProc = loginCmd.execute()
    def loginOut = new StringBuffer()
    def loginErr = new StringBuffer()
    loginProc.consumeProcessOutput(loginOut, loginErr)
    loginProc.waitFor()

    TOKEN = loginOut.toString().trim()

    if (!TOKEN || TOKEN.length() < 10) {
        println "[DEBUG] Login failed: ${loginErr.toString()}"
        return ["Could not retrieve token â€” check credentials or MotioCI server."]
    }

    // --- List Projects from MotioCI ---
    def listCmd = [
        "bash", "-c",
        """
        cd ${WORKSPACE} &&
        ${PYTHON} ci-cli.py --server=${MOTIO_SERVER} \
          project ls --xauthtoken ${TOKEN} \
          --instanceName ${SOURCE_ENV}
        """
    ]
    def listProc = listCmd.execute()
    def listOut = new StringBuffer()
    def listErr = new StringBuffer()
    listProc.consumeProcessOutput(listOut, listErr)
    listProc.waitFor()

    def raw = listOut.toString().trim()
    if (!raw) {
        println "[DEBUG] Empty response: ${listErr}"
        return ["No projects found or access denied."]
    }

    // --- Parse JSON output ---
    def json = new JsonSlurper().parseText(raw)
    def edges = json?.data?.instances?.edges ?: []
    edges.each { e ->
        e?.node?.projects?.edges?.each { p ->
            def name = p?.node?.name
            if (name) projects << name
        }
    }

    return projects.isEmpty() ? ["No projects found in ${SOURCE_ENV}"] : projects.unique().sort()

} catch (Exception e) {
    return ["Error fetching projects: ${e.message}"]
} finally {
    tmpCredFile.delete()
}
