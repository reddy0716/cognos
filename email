properties([
  parameters([

    //Source Environment
    [
      $class: 'ChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'SOURCE_ENV',
      description: 'Select Cognos Source Environment',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [], sandbox: true,
          script: "return ['Error loading environments']"
        ],
        script: [
          classpath: [], sandbox: true,
          script: """
            return ['Cognos-DEV/TEST', 'Cognos-SIT', 'Cognos-UAT']
          """
        ]
      ]
    ],

    //Target Environment (Reactive)
    [
      $class: 'CascadeChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'TARGET_ENV',
      description: 'Select Target Cognos Environment',
      referencedParameters: 'SOURCE_ENV',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [], sandbox: true,
          script: "return ['Error loading targets']"
        ],
        script: [
          classpath: [], sandbox: true,
          script: """
            if (SOURCE_ENV == 'Cognos-DEV/TEST') return ['Cognos-SIT','Cognos-UAT','Cognos-PRD']
            else if (SOURCE_ENV == 'Cognos-SIT') return ['Cognos-UAT','Cognos-PRD']
            else return ['Cognos-PRD']
          """
        ]
      ]
    ],

    //Dynamic Project List (from projects.txt)
    [
      $class: 'ChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'PROJECT_NAME',
      description: 'Select MotioCI Project (auto-loaded after first login)',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [], sandbox: true,
          script: "return ['(Run MotioCI Login once to fetch projects)']"
        ],
        script: [
          classpath: [], sandbox: true,
          script: """
            import java.nio.file.*
            def f = new File("${WORKSPACE}/projects.txt")
            if (f.exists()) {
              def lines = f.readLines().findAll { it?.trim() }
              if (lines) return lines
              else return ['(No projects found — rerun login)']
            } else {
              return ['(projects.txt not found — run MotioCI Login stage first)']
            }
          """
        ]
      ]
    ],

    //Dynamic Folder List (depends on Project)
    [
      $class: 'CascadeChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'OBJECT_PATH',
      description: 'Select Folder or Report Path (auto-loaded from folders.txt)',
      referencedParameters: 'PROJECT_NAME',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [], sandbox: true,
          script: "return ['(No folders found)']"
        ],
        script: [
          classpath: [], sandbox: true,
          script: """
            import java.nio.file.*
            def f = new File("${WORKSPACE}/folders.txt")
            if (f.exists()) {
              def lines = f.readLines().findAll { it?.trim() }
              if (lines) return lines
              else return ['(Empty — rerun login)']
            } else {
              return ['(folders.txt not found — run MotioCI Login)']
            }
          """
        ]
      ]
    ],

    //Manual Project & Path overrides
    [
      $class: 'DynamicReferenceParameter',
      name: 'PROJECT_NAME_MANUAL',
      description: 'Enter Project manually if not listed',
      defaultValue: ''
    ],
    [
      $class: 'DynamicReferenceParameter',
      name: 'OBJECT_PATH_MANUAL',
      description: 'Enter Folder Path manually if not listed',
      defaultValue: ''
    ],
    [
      $class: 'StringParameterDefinition',
      name: 'ROLLBACK_LABEL',
      defaultValue: '',
      description: 'Enter existing label name to redeploy'
    ]
  ])
])
